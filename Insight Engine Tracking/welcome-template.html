<!DOCTYPE html>
<html>

<head>
    <title>Document Access Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Anime.js Library for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        /* --- Base Styles --- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Verizon NHG TX", Arial, Helvetica, sans-serif;
            line-height: 1.5;
            margin: 0;
            background-color: #F6F6F6;
            color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Main Layout Container --- */
        .document-container {
            background-color: #FFFFFF;
            padding: 20px;
            max-width: 1400px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 25px;
            height: calc(100vh - 40px);
            max-height: 800px;
        }

        /* --- Column Styles --- */
        .sidebar,
        .whats-inside,
        .main-content {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            padding: 0 15px;
        }

        .sidebar,
        .whats-inside {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #EE0000;
            flex-shrink: 0;
        }

        .column-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
            color: #000000;
        }

        .scrollable-content {
            overflow-y: auto;
            height: 100%;
            padding-right: 10px;
            /* For scrollbar spacing */
        }

        /* --- Header in Main Column --- */
        .header {
            background-color: #000000;
            color: #FFFFFF;
            padding: 25px 30px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: bold;
            animation: titlePulse 3s ease-in-out infinite alternate;
        }

        @keyframes titlePulse {
            0% {
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            }

            100% {
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(238, 0, 0, 0.3);
            }
        }

        .header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        /* --- "What's Inside" Specifics --- */
        .info-section {
            margin: 20px 0;
        }

        .info-section h5 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: bold;
            color: #000000;
        }

        .info-section p,
        .info-section li {
            font-size: 12px;
            color: #333333;
        }

        .info-section strong {
            color: #EE0000;
        }

        .toc-list {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }

        /* --- Main Content Specifics --- */
        .file-info-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .file-info-section h2 {
            font-size: 20px;
            margin: 0 0 5px 0;
            word-wrap: break-word;
        }

        .file-info-section p {
            font-size: 14px;
            color: #555;
            margin: 0;
        }

        .insight-engine-overview {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            border-left: 4px solid #4f46e5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .insight-engine-overview h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #3730a3;
        }

        .insight-engine-overview p {
            font-size: 13px;
            line-height: 1.6;
        }

        .action-buttons-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .access-btn,
        .prompt-generator-btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            text-align: center;
        }

        .access-btn {
            background-color: #CD040B;
            color: #FFFFFF;
        }

        .access-btn:hover {
            background-color: #a70409;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .prompt-generator-btn {
            background-color: #333333;
            color: #FFFFFF;
        }

        .prompt-generator-btn:hover {
            background-color: #000000;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* --- News Sidebar Specifics --- */
        .news-item {
            margin-bottom: 20px;
        }

        .news-item strong {
            display: block;
            font-size: 13px;
            color: #000;
        }

        .news-item em {
            font-size: 11px;
            color: #555;
        }

        /* --- Animations & Responsiveness --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .document-container {
            animation: fadeIn 0.8s ease-out;
        }

        @media (max-width: 1200px) {
            .document-container {
                grid-template-columns: 1fr 1.5fr;
            }

            .sidebar {
                display: none;
            }

            /* Hide right sidebar on medium screens */
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: flex-start;
            }

            .document-container {
                grid-template-columns: 1fr;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
                gap: 15px;
            }

            .whats-inside {
                order: 2;
            }

            /* Move to bottom */
            .main-content {
                order: 1;
            }
        }

        /* Custom Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
    </style>
</head>

<body>
    <div class="document-container">
        <!-- "What's Inside" Column -->
        <div class="whats-inside">
            <div class="column-header">
                <span>📋</span>
                <h4>What's Inside</h4>
            </div>
            <div class="scrollable-content">
                <!-- Dynamic content will be injected here from template data -->
                <div id="whatsInsideContent">
                    <!-- Default content -->
                    <div class="info-section">
                        <h5>What's New</h5>
                        <p>This weekly report now includes <strong>Fixed Wireless Access (FWA)</strong> and updated
                            <strong>Second Line Activity</strong> metrics.
                        </p>
                    </div>
                    <div class="info-section">
                        <h5>Key Sections</h5>
                        <ul class="toc-list">
                            <li>Consumer Growth & Port Activity</li>
                            <li>Business Postpaid Performance</li>
                            <li>Prepaid Customer Growth (VVO)</li>
                            <li>Channel Mix Analysis (Direct/Indirect)</li>
                        </ul>
                    </div>
                    <div class="info-section">
                        <h5>Data Source</h5>
                        <p>All data is sourced from the Enterprise Data Warehouse and is current as of {{TIMESTAMP}}.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Column -->
        <div class="main-content">
            <div class="header">
                <h1>{{DOCUMENT_NAME}}</h1>
                <p>Welcome to Insight Engine</p>
            </div>
            <div class="file-info-section">
                <h2>Document Overview</h2>
                <p>Last updated: {{LAST_MODIFIED}}</p>
            </div>
            <div class="insight-engine-overview">
                <h4>🚀 About the Insight Engine</h4>
                <p>The Insight Engine is your AI-powered document analysis platform. After opening your report, leverage
                    the integrated Gemini Sidebar in Google Workspace and our advanced Prompt Generator to unlock
                    instant, intelligent insights from your data. Transform static reports into interactive, actionable
                    intelligence.</p>
            </div>
            <div class="action-buttons-section">
                <button class="access-btn" id="accessBtn" onclick="openDocument()">🚀 Launch
                    Document & Start Analysis</button>
                <button class="prompt-generator-btn" id="promptGeneratorBtn" onclick="openPromptGenerator()">⚡ Open AI Prompt Generator</button>
            </div>
        </div>

        <!-- News Sidebar Column -->
        <div class="sidebar">
            <div class="column-header">
                <span>📰</span>
                <h4>Latest Headlines</h4>
            </div>
            <div class="scrollable-content">
                <div id="newsContainer">
                    <!-- News items will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Template data injection point - DO NOT MODIFY THIS LINE
        eval('window.templateData = {{TEMPLATE_DATA_JSON}};');

        // --- Enhanced URL Detection with Multiple Fallback Sources ---
        function getFileUrl() {
            // Priority order for finding the file URL
            const sources = [
                // 1. Template data from backend (primary source)
                () => window.templateData?.FILE_URL_DIRECT,
                () => window.templateData?.FILE_URL,
                () => window.templateData?.FILE_URL_VIEW,
                () => window.templateData?.FILE_URL_EDIT,
                
                // 2. Template variables (fallback)
                () => '{{FILE_URL_DIRECT}}',
                () => '{{FILE_URL}}',
                () => '{{FILE_URL_VIEW}}',
                () => '{{FILE_URL_EDIT}}',
                
                // 3. URL parameters (for testing)
                () => {
                    const params = new URLSearchParams(window.location.search);
                    return params.get('fileUrl') || params.get('url') || params.get('file') || params.get('URL');
                }
            ];
            
            for (const source of sources) {
                const url = source();
                if (url && url !== '' && !url.startsWith('{{') && url !== 'undefined') {
                    console.log('📁 File URL found:', url);
                    return url;
                }
            }
            
            console.warn('⚠️ No file URL found in any source');
            return null;
        }

        // --- Document Access Function with Enhanced Error Handling ---
        function openDocument() {
            try {
                const fileUrl = getFileUrl();
                
                if (!fileUrl) {
                    showAlert('Document URL not available. Please check the file link or try again later.', 'warning');
                    return;
                }

                // Show loading state
                const accessBtn = document.getElementById('accessBtn');
                const originalText = accessBtn.textContent;
                accessBtn.textContent = '🔄 Opening Document...';
                accessBtn.disabled = true;

                // Track the access attempt using server-side function
                recordButtonClick(window.templateData?.FILE_ID || 'unknown', 'document_access')
                    .then(() => console.log('✅ Document access tracked'))
                    .catch(err => console.warn('⚠️ Tracking failed:', err));

                // Open the document
                window.open(fileUrl, '_blank');
                
                // Reset button after short delay
                setTimeout(() => {
                    accessBtn.textContent = originalText;
                    accessBtn.disabled = false;
                }, 2000);

                console.log('📊 Document opened:', fileUrl);

            } catch (error) {
                console.error('❌ Error opening document:', error);
                showAlert('An error occurred while opening the document. Please try again.', 'error');
            }
        }

        // --- Prompt Generator Function ---
        function openPromptGenerator() {
            try {
                // Get the current document URL for context
                const fileUrl = getFileUrl();
                const documentName = window.templateData?.DOCUMENT_NAME || 'Document';
                
                // Track prompt generator access
                recordButtonClick(window.templateData?.FILE_ID || 'unknown', 'prompt_generator_access')
                    .then(() => console.log('✅ Prompt generator access tracked'))
                    .catch(err => console.warn('⚠️ Tracking failed:', err));

                // Open prompt generator with document context
                const promptGeneratorUrl = getPromptGeneratorUrl(fileUrl, documentName);
                window.open(promptGeneratorUrl, '_blank');
                
                console.log('⚡ Prompt generator opened');

            } catch (error) {
                console.error('❌ Error opening prompt generator:', error);
                showAlert('An error occurred while opening the prompt generator. Please try again.', 'error');
            }
        }

        // --- Get Prompt Generator URL ---
        function getPromptGeneratorUrl(documentUrl, documentName) {
            // Use the main webapp URL for prompt generator
            const baseUrl = window.location.origin + window.location.pathname.replace('/exec', '');
            const params = new URLSearchParams({
                mode: 'prompt-generator',
                document: documentName,
                url: documentUrl || ''
            });
            return `${baseUrl}?${params.toString()}`;
        }

        // --- Server-side Button Click Recording ---
        function recordButtonClick(fileId, action) {
            return new Promise((resolve, reject) => {
                try {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .recordButtonClick(fileId, action);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // --- Alert System ---
        function showAlert(message, type = 'info') {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
            `;
            
            // Add styles for alert
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 400px;
                font-size: 14px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Set colors based on type
            const colors = {
                info: { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                warning: { bg: '#fff3e0', border: '#ff9800', text: '#ef6c00' },
                error: { bg: '#ffebee', border: '#f44336', text: '#c62828' },
                success: { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' }
            };
            
            const color = colors[type] || colors.info;
            alert.style.backgroundColor = color.bg;
            alert.style.borderLeft = `4px solid ${color.border}`;
            alert.style.color = color.text;
            
            document.body.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        // --- Initialize Application ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Insight Engine Document Portal Initialized');
            console.log('📊 Template Data:', window.templateData);
            
            // Load dynamic content
            loadWhatsInsideContent();
            loadNewsContent();
            initializeAnimations();
            
            // Enhanced debugging
            console.log('🔍 Available file URLs:');
            console.log('  - Direct:', window.templateData?.FILE_URL_DIRECT);
            console.log('  - View:', window.templateData?.FILE_URL_VIEW);
            console.log('  - Edit:', window.templateData?.FILE_URL_EDIT);
            console.log('  - Preview:', window.templateData?.FILE_URL_PREVIEW);
            console.log('📁 Selected URL:', getFileUrl());
        });

        // --- Load What's Inside Content ---
        function loadWhatsInsideContent() {
            try {
                const whatsInsideContainer = document.getElementById('whatsInsideContent');
                
                // Use dynamic content if available from template data
                if (window.templateData?.WHATS_INSIDE_HTML) {
                    whatsInsideContainer.innerHTML = window.templateData.WHATS_INSIDE_HTML;
                    console.log('✅ What\'s Inside content loaded from template data');
                }
                // Otherwise, keep the default content already in HTML
                
            } catch (error) {
                console.error('❌ Error loading What\'s Inside content:', error);
            }
        }

        // --- Load News Content ---
        function loadNewsContent() {
            try {
                let newsItems = [];

                if (window.templateData?.NEWS_HEADLINES) {
                    newsItems = window.templateData.NEWS_HEADLINES;
                } else {
                    // Mock news data for preview
                    newsItems = [
                        { title: "Verizon CFO discusses turning AI into a revenue source", source: "Fortune", date: "Sep 16, 2025" },
                        { title: "Settlement reached with California on Frontier deal", source: "Light Reading", date: "Sep 16, 2025" },
                        { title: "19th consecutive year of dividend growth announced", source: "VZMail", date: "Sep 05, 2025" },
                        { title: "New iPhone SE 2025 deals now available", source: "Tech Radar", date: "Sep 01, 2025" },
                        { title: "Thriving Forward: New wellness workshops for employees", source: "About You News", date: "Aug 28, 2025" }
                    ];
                }

                const newsContainer = document.getElementById('newsContainer');
                let newsHtml = '';
                newsItems.forEach(item => {
                    newsHtml += `<div class="news-item">
                                    <strong>${item.title}</strong>
                                    <em>${item.source} - ${item.date}</em>
                                 </div>`;
                });
                newsContainer.innerHTML = newsHtml;
                
                console.log('✅ News content loaded:', newsItems.length, 'items');

            } catch (error) {
                console.error('❌ Error loading news content:', error);
            }
        }

        // --- Initialize Animations ---
        function initializeAnimations() {
            // Only proceed if anime.js is loaded
            if (typeof anime === 'undefined') {
                console.warn('⚠️ Anime.js not loaded, skipping animations');
                return;
            }

            try {
                // Header animation with scale and bounce
                anime({
                    targets: '.header',
                    scale: [0.8, 1],
                    opacity: [0, 1],
                    duration: 1000,
                    easing: 'easeOutElastic(1, .6)',
                    delay: 100
                });

                // File info section with slide up
                anime({
                    targets: '.file-info-section',
                    translateY: [30, 0],
                    opacity: [0, 1],
                    duration: 800,
                    easing: 'easeOutExpo',
                    delay: 300
                });

                // Insight engine overview with pulse effect
                anime({
                    targets: '.insight-engine-overview',
                    scale: [0.9, 1],
                    opacity: [0, 1],
                    duration: 1000,
                    easing: 'easeOutBack',
                    delay: 500
                });

                // Buttons with staggered animation
                anime({
                    targets: '.action-buttons-section .access-btn, .action-buttons-section .prompt-generator-btn',
                    translateY: [40, 0],
                    opacity: [0, 1],
                    scale: [0.8, 1],
                    duration: 800,
                    delay: anime.stagger(200, { start: 700 }),
                    easing: 'easeOutBack'
                });

                // Sidebar animations
                anime({
                    targets: '.whats-inside',
                    translateX: [-50, 0],
                    opacity: [0, 1],
                    duration: 1000,
                    delay: 200,
                    easing: 'easeOutExpo'
                });

                anime({
                    targets: '.sidebar',
                    translateX: [50, 0],
                    opacity: [0, 1],
                    duration: 1000,
                    delay: 400,
                    easing: 'easeOutExpo'
                });

                // News items individual animation
                anime({
                    targets: '.news-item',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    duration: 600,
                    delay: anime.stagger(100, { start: 800 }),
                    easing: 'easeOutExpo'
                });

                // Column headers with rotation effect
                anime({
                    targets: '.column-header',
                    rotateY: [90, 0],
                    opacity: [0, 1],
                    duration: 800,
                    delay: anime.stagger(150, { start: 600 }),
                    easing: 'easeOutExpo'
                });

                // Add enhanced button interactions
                addButtonInteractions();
                
                console.log('✅ Animations initialized');

            } catch (error) {
                console.error('❌ Error initializing animations:', error);
            }
        }

        // --- Add Button Interactions ---
        function addButtonInteractions() {
            const accessBtn = document.getElementById('accessBtn');
            const promptBtn = document.getElementById('promptGeneratorBtn');

            [accessBtn, promptBtn].forEach(btn => {
                if (!btn) return;

                btn.addEventListener('mouseenter', () => {
                    anime({
                        targets: btn,
                        scale: 1.05,
                        duration: 200,
                        easing: 'easeOutQuad'
                    });
                });

                btn.addEventListener('mouseleave', () => {
                    anime({
                        targets: btn,
                        scale: 1,
                        duration: 200,
                        easing: 'easeOutQuad'
                    });
                });

                btn.addEventListener('click', () => {
                    anime({
                        targets: btn,
                        scale: [1, 0.95, 1],
                        duration: 300,
                        easing: 'easeOutElastic(1, .6)'
                    });
                });
            });
        }

        // --- Additional CSS for alerts (added dynamically) ---
        const alertStyles = document.createElement('style');
        alertStyles.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .alert {
                font-family: "Verizon NHG TX", Arial, sans-serif;
            }
        `;
        document.head.appendChild(alertStyles);
    </script>
</body>

</html>
